<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title></title>

      <!-- css -->
      <link rel="stylesheet" href="/reset.css">
      <link rel="stylesheet" href="/feather.css">

      <!-- fonts -->
      <link href="https://fonts.googleapis.com/css?family=Merriweather:300,400|Montserrat:400,700" rel="stylesheet">

      <!-- js -->
      <script src='/js/images.js'></script>
      <script src='/js/main.js'></script>

      <script async src='https://www.googletagmanager.com/gtag/js?id=UA-62288351-2'></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-62288351-2');</script>

      

      
      
    </head>

    <body>

    <a href="/">
      <div class='header-image' style='background-image: url(&#x2F;theme_images&#x2F;default.gif);'></div>
    </a>

    
<div class='container'>
  <section class="post">
  	<div class="title-and-info">
    	<h2>Creating a simple synthesizer VST plugin in Rust</h2>
    	<div class="info">
    		<span>15 minute read</span>
    		<span class='divider'/>
    			<span>03 January 2018</span>
    		<span class='divider'/>
          <!-- link to page category if user is building categories -->
          <span><a href="/categories/tutorial">tutorial</a></span>
    		
    	</div>
    </div>
  	<article>
  		<p>Welcome to 2018!  A lot happened this past year - the most important of which being the 0.0.1 release of <a href="https://crates.io/crates/vst"><code>vst</code></a> on Crates.io.</p>
<h1 id="preface">Preface</h1>
<p>If you know what you're looking for (e.g., if you came here from a Google search) and you're antsy to get into code, just go ahead and skip to the bits where we start coding.  Or read the notes that I slaved away at writing.  Up to you.</p>
<h2 id="about">About</h2>
<p><code>vst</code> is a crate that implements the VST 2.4 specification by Steinberg.  VSTs (Virtual Studio Technology) are audio plugins used in a variety of applications.  Its basic features are as follows:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/MIDI">MIDI</a> input and output</li>
<li>Effects processing</li>
<li>Audio synthesis</li>
</ul>
<p>If you're here from a Google search, chances are you already know this.  You also probably know of other solutions like JUCE, DPlug, or wdl-ol.  If you're thinking &quot;Oh boy! Finally, I can ditch C++ for Rust!&quot; - I like your enthusiasm, but the <code>vst</code> crate isn't quite there yet!  It's not much of a framework, and instead just lets you interact with MIDI notes and an audio buffer.  It also doesn't have proper UI support yet.  But hey, it's 0.0.1 - give us some time.</p>
<p>You may have also stumbled on Joe Clay's excellent post, <a href="https://www.seventeencups.net/posts/writing-an-audio-plugin-in-rust/">Writing an Audio Plugin in Rust</a>.  Their post and this post are similar, and I'll address that below.</p>
<h2 id="vst2-or-vst">vst2 or vst?</h2>
<p>In Joe's aforementioned example, they use <a href="https://www.seventeencups.net/posts/writing-an-audio-plugin-in-rust/">overdrivenpotato's vst2 crate</a>.  Unfortunately, this repository has been stagnant for quite some time due to having only one contributor.</p>
<p><a href="https://github.com/rust-dsp/rust-vst"><code>vst</code></a> is a fork of the original <a href="https://github.com/overdrivenpotato/rust-vst2/"><code>vst2</code></a> source, with a community of developers and maintainers keeping the project active.</p>
<p>TL;DR, you'll want to use the <code>vst</code> crate, and not the <code>vst2</code> crate.  It sounds counterintuitive, but just roll with it.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>I'm not a professional in the DSP field.  Some of the stuff I do might not be best practice or the most efficient.  However, I hope I'm qualified enough to make a &quot;getting started&quot; tutorial.  I hope you think the info I provide is valuable.</p>
<h1 id="what-we-ll-be-building">What we'll be building</h1>
<p>We'll be creating a monophonic white-noise generator.  In layman's terms, we're going to create a thing that makes <em>whooooooshhhh</em> noises, and that thing can only make one noise at a time.</p>
<h1 id="setting-up">Setting up</h1>
<p>Let's get started.  Set up a new project the same way you would for any other crate.  Let's call our VST &quot;whisper&quot;, because of the whooshing noises.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">cargo new whisper
</span></pre>
<p>After that, we need to add our <code>vst</code> dependency, as well as specify that our crate type is &quot;cdylib&quot;.  It should look like this:</p>
<div class='filename'>
  <div>Cargo.toml</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#d08770;">package</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">name</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;whisper&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">version</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;0.1.0&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">authors</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#a3be8c;">&quot;myname &lt;myemail@example.com&gt;&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#d08770;">dependencies</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;0.0.1&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> if you aren&#39;t following this tutorial to a T, and a newer version</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> has been released, you might wish to get the crate directly</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> off of our official Github repository like this:</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> vst = { git = &quot;https://github.com/rust-dsp/rust-vst&quot; }</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#d08770;">lib</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">name</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;whisper&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">crate-type</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#a3be8c;">&quot;cdylib&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Next, lets add some basic boilerplate code to get our minimal VST up and running.</p>
<div class='filename'>
  <div>src/lib.rs</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `vst` uses macros, so we&#39;ll need to specify that we&#39;re using them!
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">macro_use</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> vst</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">Info</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">derive</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">struct</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We&#39;re implementing a trait `Plugin` that does all the VST-y stuff for us.
</span><span style="background-color:#2b303b;color:#b48ead;">impl</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Plugin </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">get_info</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> Info</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">Info </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">name</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#96b5b4;">to_string</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Used by hosts to differentiate between plugins.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Don&#39;t worry much about this now - just fill in a random number.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">unique_id</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1337</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> For now, fill in the rest of our fields with `Default` info.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">..</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">default</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Make sure you call this, or nothing will happen.
</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin_main!</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span></pre>
<p>If you don't really know what's going on right now, don't worry.  Basically, we're implementing the <code>Plugin</code> trait for our <code>Whisper</code> struct.  This <code>Plugin</code> trait contains all the info we need to comply with the VST standard in a struct aptly named <code>Info</code>.</p>
<h1 id="full">Full <code>Info</code> struct options</h1>
<p>Right now, we're filling in our <code>Info</code> struct with mostly default options.  But there's a lot of stuff we can change to tell our host what our plugin does and expects.  We can find full options in the <a href="https://github.com/rust-dsp/rust-vst/blob/master/src/plugin.rs"><code>plugin.rs</code> file</a>.</p>
<ul>
<li><code>name</code> - The name of our plugin as a <code>String</code></li>
<li><code>vendor</code> - The creator (e.g. company) of our plugin as a <code>String</code></li>
<li><code>presets</code> - The number of presets as an <code>i32</code>.  We can safely ignore this for now, and if you don't know what a preset is, don't worry.</li>
<li><code>inputs</code> - The number of audio inputs as an <code>i32</code>.  This has a default of <code>2</code> (one for the left channel, one for the right).  Since we're creating a synthesizer that requires no inputs, we'll set this to <code>0</code> later.</li>
<li><code>outputs</code> - The number of audio outputs as an <code>i32</code>.  This again has a default of <code>2</code>.  This makes sense for our application which will output stereo audio.  If we were building a surround-sound white-noise-ear-blaster, we would want to change this.</li>
<li><code>unique_id</code> - This is required, but <a href="https://www.kvraudio.com/forum/viewtopic.php?t=397199">kind of pointless</a>.</li>
<li><code>version</code> - pretty self explanatory.  This is saved as an i32, but you can still do semantic versioning.  For example, a value of <code>0001</code> would be the equivalent of version <code>0.0.0.1</code>.  <code>1234</code> would be the equivalent of version <code>1.2.3.4</code>.</li>
<li><code>category</code> - This is an <a href="https://rust-dsp.github.io/rust-vst/vst/plugin/enum.Category.html">enum</a> that specifies the category of the plugin, which is used in some DAWs.  We're making a <code>Category::Synth</code>, which means we're going to create an output.  If we made a <code>Category::Effect</code>, we might process inputs and modify their buffer.</li>
<li><code>initial_delay</code>, <code>preset_chunks</code>, <code>f64_precision</code>, <code>silent_when_stopped</code> - don't worry about these right now!</li>
</ul>
<h1 id="revising-our">Revising our <code>Info</code></h1>
<p>Now that we know a little more about what we want to build, let's revisit our <code>lib.rs</code> file.</p>
<div class='filename'>
  <div>src/lib.rs</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `vst` uses macros, so we&#39;ll need to specify that we&#39;re using them!
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">macro_use</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> vst</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;"> note that we</span><span style="background-color:#2b303b;color:#b48ead;">&#39;ve</span><span style="background-color:#2b303b;color:#c0c5ce;"> added the `Category` </span><span style="background-color:#2b303b;color:#b48ead;">enum</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> use in our `Info` struct.
</span><span style="background-color:#2b303b;color:#c0c5ce;">use vst::plugin::</span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">Info</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Category</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">derive</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">struct</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We&#39;re implementing a trait `Plugin` that does all the VST-y stuff for us.
</span><span style="background-color:#2b303b;color:#b48ead;">impl</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Plugin </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">get_info</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> Info</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">Info </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">name</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#96b5b4;">to_string</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Used by hosts to differentiate between plugins.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">unique_id</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1337</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t need inputs
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">inputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We do need two outputs though.  This is default, but let&#39;s be 
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> explicit anyways.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">outputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">2</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Set our category
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">category</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Category</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Synth
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t care about other stuff, and it can stay default.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">..</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">default</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin_main!</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span></pre><h1 id="testing-our-bare-bones-plugin">Testing our bare-bones plugin</h1>
<blockquote>
<p>If you're already familiar with VST hosts, and how to load plugins, feel free to skip this part.</p>
</blockquote>
<p>We're going to need a way to test our VST plugins.  It's not as easy as running <code>cargo run</code>, though, because VSTs are <code>.dll</code>s.  They need to be run inside of a VST host.  If you use a DAW (Digital Audio Workstation), chances are you already have a VST host.  Ableton Live, FL Studio, and Logic are a few popular examples.  If you already have a VST host, look in your use manual on how to add VSTs or VST search directories.</p>
<p>If you don't have a VST host, go ahead and use the aptly named <a href="http://www.hermannseib.com/english/vsthost.htm">VST host</a>.  I'm going to be using VST host for all future examples in this tutorial.</p>
<h2 id="building-and-loading-our-plugin">Building and loading our plugin</h2>
<p>Believe it or not, we already have something we can compile and load into a host.  Go ahead and build your project.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">cargo build
</span></pre>
<p>If all goes well, you should have a successful build.  A file named <code>whisper.dll</code> should be present in your <code>target/debug</code> directory.  This is our VST file.</p>
<p>Go ahead and open VST Host, and drag our <code>whisper.dll</code> file onto the main window. It should look something like this.</p>
<p><img src="/images/creating-an-audio-plugin-with-rust/vsthost1.jpg" alt="" /></p>
<p>A bit underwhelming?  Well, it shouldn't be!  You just created your first VST plugin in Rust.  It doesn't do anything, but it loads!</p>
<p>Notice in VST Host that a single greenish node connects with the output.  This is the (stereo) audio output, like we defined in our <code>Info</code> struct.</p>
<h1 id="actually-doing-something">Actually doing something</h1>
<p>Right now, our plugin does nothing.  Let's change that, and create some white noise to fill our audio buffer.</p>
<blockquote>
<p>Warning: What we're making can be loud, and right now, it won't be controlled by anything.  It'll just be always on, which is a bit unpleasant.  Turn your volume down before you forget.</p>
</blockquote>
<p>Our <code>Plugin</code> trait has a few other functions - the most notable being <code>process</code>.  This is where we'll do a bunch of stuff with our audio buffer.</p>
<p>White noise is another name for random noise.  In other words, it's just a bunch of random samples from <code>-1.0</code> to <code>1.0</code>.  So to achieve white noise, we want to fill our <code>AudioBuffer</code> with, well, random noise.</p>
<p>Let's take a look back at our <code>lib.rs</code> file, and define a new function.</p>
<div class='filename'>
  <div>src/lib.rs</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> after our `get_info` function
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> ...
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">process</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">, </span><span style="background-color:#2b303b;color:#bf616a;">buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">AudioBuffer</span><span style="background-color:#2b303b;color:#c0c5ce;">&lt;</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `buffer.split()` gives us a tuple containing the 
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> input and output buffers.  We only care about the
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> output, so we can ignore the input by using `_`.
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">let</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">_</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">split</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Now, we want to loop over our output channels.  This
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> includes our left and right channels (or more, if you
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> are working with surround sound).
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">into_iter</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Let&#39;s iterate over every sample in our channel.
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> For every sample, we want to add a random value from
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> -1.0 to 1.0.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> ...
</span></pre>
<p>Let's build, compile, and load this new plugin.  Prepare your ears for the deafening sound of... nothing.  Every sample is <code>0</code>!  We're just outputting silence.  Let's fix this.</p>
<blockquote>
<p>Note: if you're getting a weird error compiling, make sure you close the plugin in whatever host you have it open in, as the file might not be overwritten due to it being in use.</p>
</blockquote>
<h1 id="adding-white-noise">Adding white noise</h1>
<p>Rust doesn't have a random library built in, so we'll need to add another dependency.  Let's modify our <code>Cargo.toml</code> file to remedy this.</p>
<div class='filename'>
  <div>Cargo.toml</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> ...</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#d08770;">dependencies</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;0.0.1&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">rand</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">&quot;0.3&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> ...</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Now let's modify our main file to add random values from <code>-1.0</code> to <code>1.0</code> to our buffer.</p>
<div class='filename'>
  <div>src/lib.rs</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `vst` uses macros, so we&#39;ll need to specify that we&#39;re using them!
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">macro_use</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> vst</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> rand</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">Info</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Category</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">AudioBuffer</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">rand</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">random</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">derive</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">struct</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We&#39;re implementing a trait `Plugin` that does all the VST-y stuff for us.
</span><span style="background-color:#2b303b;color:#b48ead;">impl</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Plugin </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">get_info</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> Info</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">Info </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">name</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#96b5b4;">to_string</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Used by hosts to differentiate between plugins.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">unique_id</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1337</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t need inputs
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">inputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We do need two outputs though.  This is default, but let&#39;s be 
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> explicit anyways.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">outputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">2</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Set our category
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">category</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Category</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Synth</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t care about other stuff, and it can stay default.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">..</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">default</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">process</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">, </span><span style="background-color:#2b303b;color:#bf616a;">buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">AudioBuffer</span><span style="background-color:#2b303b;color:#c0c5ce;">&lt;</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `buffer.split()` gives us a tuple containing the 
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> input and output buffers.  We only care about the
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> output, so we can ignore the input by using `_`.
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">let</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">_</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">split</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Now, we want to loop over our output channels.  This
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> includes our left and right channels (or more, if you
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> are working with surround sound).
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">into_iter</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Let&#39;s iterate over every sample in our channel.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> For every sample, we want to add a random value from
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> -1.0 to 1.0.
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#c0c5ce;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">random</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">&lt;</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0.</span><span style="background-color:#2b303b;color:#d08770;">5</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">*</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">2</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin_main!</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span></pre>
<p>Notice the additional crate and <code>use</code> statement at the top of the file.</p>
<p>You might be wondering what the weird math does.<br />
<code>*output_sample = (random::&lt;f32&gt;() - 0.5f32) * 2f32;</code> looks weird, right?  What's with the extra operations?</p>
<p>Well, our <code>random</code> function gives us a number between <code>0.0</code> and <code>1.0</code>, instead of <code>-1.0</code> and <code>1.0</code> like we want.  By subtracting <code>0.5</code> and then multiplying by <code>2.0</code>, we can get our desired result.</p>
<h2 id="performance">Performance</h2>
<p>This method is poorly optimized, due to calling the <code>random</code> function for every sample.  This tutorial won't delve into optimization, but if you want to look at a possible solution, check out <a href="https://github.com/resamplr/rsynth/blob/master/examples/test_synth.rs">this example</a>.</p>
<p>When building other plugins, be sure to test and/or distribute your builds with the <a href="https://doc.rust-lang.org/cargo/guide/creating-a-new-project.html"><code>--release</code></a> flag.  This turns on certain optimizations that will help your plugin be more performant, at the cost of longer build times.</p>
<h1 id="adding-events">Adding events</h1>
<p>If you build and test your synth now, you'll see that it outputs horrible white noise, <em>all of the time</em>.  Most VST instruments respond to MIDI input, e.g. notes on a piano.  Instead of having our instrument produce noise all the time, let's make it so it only produces noise when a note is pressed.</p>
<blockquote>
<p>Note: If you're using VST Host, you can play MIDI notes by hooking up the MIDI node and playing notes on the keyboard (which can be enabled on the top bar).</p>
</blockquote>
<p>Because our instrument is unpitched, we don't care about <em>what</em> note is playing.  We just want to make sure sound is playing as long as there is a note being pressed.  We can do this quite simply  by adding 1 to a counter whenever we receive a <code>note_on</code> event, and subtracting 1 from the counter whenever a <code>note_off</code> event is received.</p>
<blockquote>
<p>Note: White noise is unpitched.  No matter what note plays, the waveform will look the same.  That's not necessarily true for all synthesizers, so keep in mind that the following solution will not be appropriate for all instruments.  Our solution is also not very robust and is prone to breaking if our VST Host doesn't perform perfectly.  However, it's a good introduction to events.</p>
</blockquote>
<p>We're making a big change to the code, but it'll be our last for now.  Let's go through the whole thing, and document changes through comments.</p>
<div class='filename'>
  <div>src/lib.rs</div>
</div>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">macro_use</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> vst</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">extern</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">crate</span><span style="background-color:#2b303b;color:#c0c5ce;"> rand</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">Info</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Plugin</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> Category</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">AudioBuffer</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">event</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Event</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">vst</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">api</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Events</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">use</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">rand</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">random</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">#</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#bf616a;">derive</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">struct</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We added a counter in our plugin struct.  
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Thanks to Mathias Lengler for a correction in this code.
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#bf616a;">notes</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">u8</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We&#39;re implementing a trait `Plugin` that does all the VST-y stuff for us.
</span><span style="background-color:#2b303b;color:#b48ead;">impl</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Plugin </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">get_info</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> Info</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">Info </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">name</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#96b5b4;">to_string</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Used by hosts to differentiate between plugins.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">unique_id</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1337</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t need inputs
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">inputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We do need two outputs though.  This is default, but let&#39;s be 
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> explicit anyways.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">outputs</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">2</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Set our category
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">category</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Category</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Synth</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t care about other stuff, and it can stay default.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">..</span><span style="background-color:#2b303b;color:#c0c5ce;">Default</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">default</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Here&#39;s the function that allows us to receive events
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">process_events</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">, </span><span style="background-color:#2b303b;color:#bf616a;">events</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#c0c5ce;">Events</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Some events aren&#39;t MIDI events - so let&#39;s do a match
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> to make sure we only get MIDI, since that&#39;s all we care about.
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> event </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> events.</span><span style="background-color:#2b303b;color:#96b5b4;">events</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#b48ead;">match</span><span style="background-color:#2b303b;color:#c0c5ce;"> event </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#c0c5ce;">Event</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Midi</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">ev</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Check if it&#39;s a noteon or noteoff event.
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> This is difficult to explain without knowing how the MIDI standard works.
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Basically, the first byte of data tells us if this signal is a note on event
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> or a note off event.  You can read more about that here: 
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> https://www.midi.org/specifications/item/table-1-summary-of-midi-message
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#b48ead;">match</span><span style="background-color:#2b303b;color:#c0c5ce;"> ev.data</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> if note on, increment our counter
</span><span style="background-color:#2b303b;color:#c0c5ce;">                        </span><span style="background-color:#2b303b;color:#d08770;">144</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">.notes </span><span style="background-color:#2b303b;color:#c0c5ce;">+</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1</span><span style="background-color:#2b303b;color:#b48ead;">u8</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> if note off, decrement our counter
</span><span style="background-color:#2b303b;color:#c0c5ce;">                        </span><span style="background-color:#2b303b;color:#d08770;">128</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">.notes </span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">1</span><span style="background-color:#2b303b;color:#b48ead;">u8</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                        </span><span style="background-color:#2b303b;color:#c0c5ce;">_</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                    </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> if we cared about the pitch of the note, it&#39;s stored in `ev.data[1]`.
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We don&#39;t care if we get any other type of event
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#c0c5ce;">_</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">fn</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">process</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">, </span><span style="background-color:#2b303b;color:#bf616a;">buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&amp;</span><span style="background-color:#2b303b;color:#b48ead;">mut</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">AudioBuffer</span><span style="background-color:#2b303b;color:#c0c5ce;">&lt;</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> We only want to process *anything* if a note is
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> being held.  Else, we can return early and skip
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> processing anything!
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">if</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">self</span><span style="background-color:#2b303b;color:#c0c5ce;">.notes </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">return</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> `buffer.split()` gives us a tuple containing the 
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> input and output buffers.  We only care about the
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> output, so we can ignore the input by using `_`.
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">let</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">_</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">split</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Now, we want to loop over our output channels.  This
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> includes our left and right channels (or more, if you
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> are working with surround sound).
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_buffer.</span><span style="background-color:#2b303b;color:#96b5b4;">into_iter</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> Let&#39;s iterate over every sample in our channel.
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#b48ead;">for</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">in</span><span style="background-color:#2b303b;color:#c0c5ce;"> output_channel </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> For every sample, we want to add a random value from
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#65737e;">//</span><span style="background-color:#2b303b;color:#65737e;"> -1.0 to 1.0.
</span><span style="background-color:#2b303b;color:#c0c5ce;">                </span><span style="background-color:#2b303b;color:#c0c5ce;">*</span><span style="background-color:#2b303b;color:#c0c5ce;">output_sample </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">random</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">&lt;</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0.</span><span style="background-color:#2b303b;color:#d08770;">5</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">*</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">2</span><span style="background-color:#2b303b;color:#b48ead;">f32</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">            </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">        </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">plugin_main!</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">Whisper</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">;</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span></pre>
<p>Build and compile our code, and your plugin should work wonderfully.  It'll only create the horrible harsh white-noise when a key is being held.  We can also mash down a bunch of keys at once without stopping generating sound.</p>
<p>Please again note that this is a <em>very</em> rudimentary system, and it's very specific to our use case.</p>
<h1 id="takeaways-and-source-code">Takeaways and source code</h1>
<p>Hopefully by now you have a rough understanding of how to create VSTs and modify audio buffers in Rust.  In the future, I hope to expound on certain subjects, like creating controls or creating effects.</p>
<p>The source code can be found <a href="https://github.com/resamplr/rust-noise-vst-tutorial">on Github here</a>.</p>
<h1 id="fixes">Fixes</h1>
<p>If you find an issue with the above code, let me know.  The best way is to <a href="https://github.com/resamplr/rust-noise-vst-tutorial/issues/new">open an issue</a> on the example repository.<br />
Thanks to:</p>
<ul>
<li>
<p><a href="https://github.com/MathiasLengler">Mathias Lengler</a> for their <a href="https://www.reddit.com/r/rust/comments/7o1qnp/creating_a_simple_synthesizer_vst_plugin_in_rust/ds6hm82/?utm_content=permalink&amp;utm_medium=front&amp;utm_source=reddit&amp;utm_name=rust">fix</a> regarding an unnecessary usage of <code>Cell</code>.</p>
</li>
<li>
<p><a href="https://github.com/aochagavia">Adolfo Ochagava</a> for <a href="https://github.com/resamplr/vaporsoft/pull/1">their insight</a> in adding the <code>--release</code> flag to cargo builds to further optimize code.</p>
</li>
<li>
<p><a href="https://github.com/zyvitski">Alex Zywicki</a> for their <a href="https://github.com/resamplr/rust-noise-vst-tutorial/commit/810e9f4640ee28530bba1fe19d5d6ef12fec134f">fix</a> for refactoring the code without the need for an input buffer.</p>
</li>
</ul>
<h1 id="extra-resources">Extra resources</h1>
<p>If you're totally sold on building VSTs with Rust, check out <a href="https://tinyurl.com/ya5ff5ef">the official Rust VST Telegram chat</a>.  We're a friendly community who are eager to advise new users and help maintain better code.</p>
<p>If you're coming from something like JUCE and miss the abstraction, check out my <a href="https://github.com/resamplr/rsynth">rsynth</a> project.  It helps abstract a lot of what we did in this tutorial with stuff like voice managers.  Note that it's super-alpha-in-development-broken code and needs a lot of work, but at least check out the examples.</p>
<h1 id="next-time">Next time</h1>
<p>In the future, we'll create more complex applications, like a multi-voice tonal synth with band-limited sawtooth waves.  We'll also explore how to create a minimal GUI within Rust VST using your host's built in controls.</p>
<h1 id="contacting-me">Contacting me</h1>
<p>You can reach me on Mozilla's Rust IRC at <code>doomy</code> or <code>_doomy</code>.  You can also add me on telegram <a href="https://t.me/piedoomy">@piedoomy</a>, where I'm most certain to respond.</p>

  	</article>
  </section>

  <div id='disqus_thread'></div><script> var disqus_config = function () { }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://vaporsoft-net.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href='https://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>

</div>


    <footer>
      Feather theme by <a href="https://github.com/piedoom/feather">doomy</a>&nbsp;&nbsp;-&nbsp;&nbsp; Built with <a href="https://github.com/Keats/gutenberg">Gutenberg</a>
      &nbsp;&nbsp;-&nbsp;&nbsp; <a href=https:&#x2F;&#x2F;paypal.me&#x2F;piedoomy>Donate</a>
    </footer>

    </body>

</html>
