<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title></title>

      <!-- css -->
      <link rel="stylesheet" href="/reset.css">
      <link rel="stylesheet" href="/feather.css">

      <!-- fonts -->
      <link href="https://fonts.googleapis.com/css?family=Merriweather:300,400|Montserrat:400,700" rel="stylesheet">

      <!-- js -->
      <script src='/js/images.js'></script>
      <script src='/js/main.js'></script>

      <script async src='https://www.googletagmanager.com/gtag/js?id=UA-62288351-2'></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-62288351-2');</script>

      

      
      
    </head>

    <body>

    <a href="/">
      <div class='header-image' style='background-image: url(&#x2F;theme_images&#x2F;default.gif);'></div>
    </a>

    
<div class='container'>
  <section class="post">
  	<div class="title-and-info">
    	<h2>Building an authenticated web API wrapper with Crystal</h2>
    	<div class="info">
    		<span>9 minute read</span>
    		<span class='divider'/>
    			<span>20 September 2016</span>
    		<span class='divider'/>
          <!-- link to page category if user is building categories -->
          <span><a href="/categories/design">design</a></span>
    		
    	</div>
    </div>
  	<article>
  		<p><a href="https://crystal-lang.org/">Crystal</a> is an up-and-coming language very similar to Ruby, but compiled.  It's still very young, and it's changing all the time, but I've been having some fun playing around with it.  I started writing an <a href="https://github.com/piedoom/tumblr-crystal">API wrapper for Tumblr</a> (which has basically become my &quot;Hello World&quot; now...).  Unfortunately, the documentation for some parts of Crystal doesn't yet exist, so I learned a ton from the community.  Because there aren't really any tutorials on how to do this sort of thing yet, I'd like to share what I've learned.</p>
<p>Big special thanks to <a href="https://github.com/asterite">Asterite</a> and the group <a href="https://gitter.im/crystal-lang/crystal">Gitter chat</a> for all of their help!</p>
<h3 id="preface">Preface</h3>
<p>This tutorial is for beginner / moderate skill level with programming.  If you know Ruby or even Python, you'll find this super-easy.  If you're stuck on something, send me a message and I'll try to clear it up!</p>
<h3 id="installing">Installing</h3>
<p>Because it's very possible that you've just heard of Crystal for the first time, you're probably going to need to install the library.  Detailed instructions on how to do this are available on the <a href="https://crystal-lang.org/docs/installation/index.html">Crystal docs website.</a></p>
<blockquote>
<p>Note: As of September 2016, Crystal does <em>not</em> have strategy for installing on Windows computers.  If you don't have access to a *nix or MacOS machine, consider using a virtual machine.</p>
</blockquote>
<h3 id="creating-a-crystal-project">Creating a Crystal Project</h3>
<p>Once installed, it's easy to create a new Crystal project.  Let's create ours and name it <code>twitter-wrapper-test</code>.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">crystal init </span><span style="background-color:#2b303b;color:#b48ead;">lib</span><span style="background-color:#2b303b;color:#c0c5ce;"> twitter</span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;">wrapper</span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;">test
</span></pre>
<p>This will create a few files we'll use to bootstrap our project for use with Shards.  Speaking of Shards... what are they?</p>
<h3 id="getting-started-with-shards">Getting Started with Shards</h3>
<p>Shards is Crystal's dependency manager, similar to Rubygems, NPM, and NuGet.  Crystalshards is decentralized in a way, where adding a dependency is basically just adding a git URI.  As of now, however, almost all repositories are hosted on GitHub.  You can search them with <a href="https://github.com/f">Fatih Kadir AkÄ±n's</a> excellent <a href="http://crystalshards.xyz/">Crystalshards.xyz</a>.</p>
<p>Let's open up our <code>shard.yml</code> (which is similar to a Ruby project's <code>Gemfile</code>).</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#bf616a;">name</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">twitter-wrapper-test</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#bf616a;">version</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">0.1.0</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#bf616a;">authors</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">-</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">doomy &lt;myemail@email.com&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#bf616a;">license</span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">MIT</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>When a project is created, it initializes some basic information like the license, authors, and version.  Change these to your liking.  For this project, we don't need any dependencies.  Everything we need is built into the standard library!  (Awesome, right?)</p>
<h3 id="getting-started-with-twitter">Getting started with Twitter</h3>
<p>Although I'm using Twitter, feel free to follow along with another service as you see fit.  Keep in mind, however, that I'm using OAuth 1.0 in this tutorial.  You can use 2.0 with Crystal, but the process is a bit different.</p>
<p>Anyways, let's create a new Twitter application.  Sign in or create your Twitter account, and then click <a href="https://apps.twitter.com/app/new">here</a> to generate a new app.  Don't worry about the callback URL for now, we don't need it.  Once that's finished, go to your new application's page, and click the &quot;Keys and Access Tokens&quot; tab.  At the bottom, click &quot;Create my access token&quot;.  Great!  This will create everything we need to test our API wrapper - a <code>Consumer Key</code>, <code>Consumer Secret</code>, <code>Access Token Secret</code>, and <code>Access Token</code>.</p>
<h3 id="setting-up-some-environment-variables">Setting up some environment variables</h3>
<p>These keys we've created are <strong>extremely</strong> sensitive and should be treated as you would a password.  This means that hardcoding them in our new Crystal application is a huge no-no.  Because we're using a *nix system, we can set an environment variable.  Open up your shell's <code>.rc</code> file (in most cases, <code>~/.bashrc</code>) and append the following lines:</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#b48ead;">export</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">TWITTER_CONSUMER_KEY</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">your-key-here</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">export</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">TWITTER_CONSUMER_SECRET</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">your-key-here</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">export</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">TWITTER_ACCESS_TOKEN</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">your-key-here</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">export</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">TWITTER_ACCESS_TOKEN_SECRET</span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">your-key-here</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Where <code>your-key-here</code> is replaced with the corresponding value from your Twitter app.  Save and close your editor, and then open up a new terminal, or type <code>source ~/.[your shell]rc</code> (most likely <code>source ~/.bashrc</code>).</p>
<blockquote>
<p>Do we have to name our variables <code>TWITTER_CONSUMER_KEY</code>?</p>
</blockquote>
<p>No, not really.  You can name these variables anything you like, but <code>TWITTER_CONSUMER_KEY</code> offers a lot of clarity!</p>
<h3 id="building-our-wrapper">Building our wrapper</h3>
<p>Time to do some coding.  Open up our <code>src/twitter-wrapper-test/</code> directory, and create a new file called <code>client.cr</code>.  Before we write any code, let's explain <em>how</em> and <em>why</em> we're going to structure the project like we are.</p>
<h5 id="static-classes-vs-instantiation">Static Classes vs. Instantiation</h5>
<p>We're going to instantiate the <code>client</code> class in order to perform requests.  Although we could definitely use a <code>static</code> class, it would have to be stateful and remember OAuth credentials.  Stateful static classes aren't very clear when implemented, so we're going to simply instatiate a new <code>client</code> object.</p>
<h3 id="setting-up-an-http-object-with-oauth">Setting up an HTTP object with OAuth</h3>
<p>Crystal provides OAuth support in its standard library.  Neat!  Let's open up our <code>client.cr</code> file and add a few <code>require</code> statements.  Let's also make a <code>module</code> that's the same name as our library.  (Notice that our <code>init</code> automatically created <code>Twitter::Wrapper::Test</code> because of the dashes.  This actually should probably be <code>TwitterWrapperTest</code>, so feel free to change all occurrences if you'd like.  For simplicity's sake, I'll just use what it generated).</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#8fa1b3;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">oauth</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#8fa1b3;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">http/client</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#8fa1b3;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">uri</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">module</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Twitter</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Wrapper</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Test</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Inside our module, we're going to create a new client class, with an initialize.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#b48ead;">class</span><span style="background-color:#2b303b;color:#eff1f5;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">Client</span><span style="background-color:#2b303b;color:#eff1f5;">
</span><span style="background-color:#2b303b;color:#eff1f5;">
</span><span style="background-color:#2b303b;color:#eff1f5;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">Host</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">api.twitter.com</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> create a new client with oauth support
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">def</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">initialize</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">consumer_key</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">consumer_secret</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">oauth_token</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">oauth_token_secret</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> create our OAuth consumer and token with the built in library!
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">consumer </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">OAuth</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#ebcb8b;">Consumer</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">new</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">Host</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> consumer_key</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> consumer_secret</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">token </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">OAuth</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#ebcb8b;">AccessToken</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">new</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">oauth_token</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> oauth_token_secret</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> create an instance of the HTTP client using HTTPS
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">@</span><span style="background-color:#2b303b;color:#bf616a;">http_client</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">HTTP</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#ebcb8b;">Client</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">new</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">Host</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">tls</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">true</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">port</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">443</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> use the `authenticate` method on our consumer variable to authenticate our HTTP client with each request.  Neat!
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">consumer</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">authenticate</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">@</span><span style="background-color:#2b303b;color:#bf616a;">http_client</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> token</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>And that's just about it!  One of the most painless OAuth implementations in history :)</p>
<h3 id="getting-information-from-an-endpoint">Getting information from an endpoint</h3>
<p>Twitter provides multiple endpoints for fetching JSON data.  For this tutorial, we're just going to search for some tweets.  You can read more about it's specification <a href="https://dev.twitter.com/rest/reference/get/search/tweets">here</a>.  Twitter provides some awesome API docs.</p>
<p>In our client, let's add a new method called <code>tweet_search</code>.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#b48ead;">def</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">tweet_search</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">query</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">response </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> get</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">/1.1/search/tweets.json</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">q</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> query</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Simple enough, right?  Well, if we tried to run this right now, we'd get a compiler error because our <code>get</code> method doesn't yet exist.  Let's create that, and a few other useful methods in our client class.</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> generic function for getting JSON
</span><span style="background-color:#2b303b;color:#8fa1b3;">private</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">def</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">get</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">path</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">params</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;"> of </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">=&gt;</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> add parameters to our string
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">path </span><span style="background-color:#2b303b;color:#c0c5ce;">+=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">?</span><span style="background-color:#2b303b;color:#ab7967;">#{</span><span style="background-color:#2b303b;color:#a3be8c;">to_query_params</span><span style="background-color:#2b303b;color:#a3be8c;">(</span><span style="background-color:#2b303b;color:#a3be8c;">params</span><span style="background-color:#2b303b;color:#a3be8c;">)</span><span style="background-color:#2b303b;color:#ab7967;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">unless</span><span style="background-color:#2b303b;color:#c0c5ce;"> params</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">empty?
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> finally, get our response
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">response </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">@</span><span style="background-color:#2b303b;color:#bf616a;">http_client</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">get</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">path</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> handle the response properly and check for errors
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">handle_response</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">response</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#8fa1b3;">private</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">def</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">handle_response</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">response</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">HTTP</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#ebcb8b;">Client</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Response</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">case</span><span style="background-color:#2b303b;color:#c0c5ce;"> response</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">status_code
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">when</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#d08770;">200</span><span style="background-color:#2b303b;color:#c0c5ce;">..</span><span style="background-color:#2b303b;color:#d08770;">299</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">response</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">body
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">else</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#8fa1b3;">raise</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#ab7967;">#{</span><span style="background-color:#2b303b;color:#a3be8c;">response</span><span style="background-color:#2b303b;color:#a3be8c;">.</span><span style="background-color:#2b303b;color:#a3be8c;">status_code</span><span style="background-color:#2b303b;color:#ab7967;">}</span><span style="background-color:#2b303b;color:#a3be8c;"> - </span><span style="background-color:#2b303b;color:#ab7967;">#{</span><span style="background-color:#2b303b;color:#a3be8c;">response</span><span style="background-color:#2b303b;color:#a3be8c;">.</span><span style="background-color:#2b303b;color:#a3be8c;">body</span><span style="background-color:#2b303b;color:#ab7967;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#65737e;">#</span><span style="background-color:#2b303b;color:#65737e;"> returns a URL encoded string used for query parameters
</span><span style="background-color:#2b303b;color:#8fa1b3;">private</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#b48ead;">def</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#8fa1b3;">to_query_params</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">params</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">Hash</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#ebcb8b;">HTTP</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#ebcb8b;">Params</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">build </span><span style="background-color:#2b303b;color:#b48ead;">do</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#bf616a;">form_builder</span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">params</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">each </span><span style="background-color:#2b303b;color:#b48ead;">do</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#bf616a;">key</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">value</span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#c0c5ce;">form_builder</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">add</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">key</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> value</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>These methods are pretty self explanatory.  I also have to admit, I almost entirely ripped these from <a href="https://github.com/sferik/twitter-crystal/blob/master/src/twitter/rest/client.cr">sferik's source code</a>. There's some great examples in that repo if you like reading source.  Unfortunately, there's no documentation for it yet :(</p>
<h3 id="testing">Testing</h3>
<p>Now that we have everything we need to make a simple request, let's see if our library works.</p>
<p>Open up <code>src/twitter-wrapper-test.cr</code>.  Let's write some code in the module block.</p>
<blockquote>
<p>Note: Usually, you're NEVER going to want to write app-specific code inside of a <code>lib</code> package.  Currently, there is no REPL in Crystal, so projects can't really be tested without making another Crystal application that consumes your custom library.  In order to avoid doing this for simplicity sake, we can write stuff directly in our <code>twitter-wrapper-test.cr</code> file.  Just remember to delete it before sharing!</p>
</blockquote>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">client </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">Client</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">new</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#bf616a;">ENV</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">TWITTER_CONSUMER_KEY</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> 
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#bf616a;">ENV</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">TWITTER_CONSUMER_SECRET</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#bf616a;">ENV</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">TWITTER_ACCESS_TOKEN</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#bf616a;">ENV</span><span style="background-color:#2b303b;color:#c0c5ce;">[</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">TWITTER_ACCESS_TOKEN_SECRET</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">]</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#96b5b4;">puts</span><span style="background-color:#2b303b;color:#c0c5ce;"> client</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">tweet_search</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">@crystal-lang</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>Basically, we're creating a new client with our OAuth environment variables, and then searching for tweets with the string &quot;@crystal-lang&quot;.  Let's test our application.</p>
<p><code>crystal src/twitter-wrapper-test.cr</code></p>
<p>If all goes to plan, we should get a huge strin of JSON.  This means our API authentication is working properly.</p>
<h3 id="deseralizing-json-with-crystal">Deseralizing JSON with Crystal</h3>
<p>Crystal provides some awesome, magical ways to deseralize JSON easily.  So let's get started!  Create a new file, <code>src/twitter-wrapper-test/tweet.cr</code>.</p>
<p>We need to deserialize JSON that looks like <a href="https://dev.twitter.com/rest/reference/get/search/tweets">this</a> (scroll down to the bottom for JSON examples).  There's a LOT of different properties for each tweet.  Let's just keep it basic and parse the <code>text</code>, <code>id</code>, and <code>user</code> properties.</p>
<p>In our <code>tweet.cr</code>...</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#8fa1b3;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">json</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">module</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Twitter</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Wrapper</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Test</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">class</span><span style="background-color:#2b303b;color:#eff1f5;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">Tweet</span><span style="background-color:#2b303b;color:#eff1f5;">
</span><span style="background-color:#2b303b;color:#eff1f5;">    </span><span style="background-color:#2b303b;color:#ebcb8b;">JSON</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">mapping</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">text</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">id</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">Int64</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">user</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">User</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>The <code>JSON.mapping</code> macro is an easy way for Crystal to figure out what properties of an object will be accessible, and how to deserialize/serialize the object to and from JSON.</p>
<p>You might notice that our <code>user</code> property has a type that isn't already defined.  We need to make a new <code>User</code> class.  Create a new file as <code>src/twitter-wrapper-test/user.cr</code>. Again, there's a ton of properties given to us over JSON, so let's just take a few - <code>id</code>, <code>description</code>, and <code>screen_name</code>.</p>
<p>In our <code>user.cr</code>...</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#8fa1b3;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">json</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">module</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">Twitter</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Wrapper</span><span style="background-color:#2b303b;color:#c0c5ce;">::</span><span style="background-color:#2b303b;color:#c0c5ce;">Test</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">class</span><span style="background-color:#2b303b;color:#eff1f5;"> </span><span style="background-color:#2b303b;color:#ebcb8b;">User</span><span style="background-color:#2b303b;color:#eff1f5;">
</span><span style="background-color:#2b303b;color:#eff1f5;">    </span><span style="background-color:#2b303b;color:#ebcb8b;">JSON</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">mapping</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">description</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">name</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">String</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">key</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">screen_name</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#a3be8c;">id</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">{</span><span style="background-color:#2b303b;color:#a3be8c;">type</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#bf616a;">Int64</span><span style="background-color:#2b303b;color:#c0c5ce;">}</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>For our <code>name</code> property, I passed in a <code>key</code> parameter with the value of &quot;screen_name&quot;.  You can use this whenever your property name doesn't match up with the JSON</p>
<h3 id="finishing-up">Finishing Up</h3>
<p>Let's reopen our <code>client.cr</code> file so we can use our new JSON enabled classes.  At the end of our <code>tweet_search</code> method, add the following:</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#b48ead;">return</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#96b5b4;">Array</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">Tweet</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">from_json</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">response</span><span style="background-color:#2b303b;color:#c0c5ce;">,</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#a3be8c;">root</span><span style="background-color:#2b303b;color:#a3be8c;">:</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">statuses</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>This will tell Crystal to use our JSON mappings to get an Array of Tweet objects in the root &quot;statuses&quot; (as defined in our JSON).</p>
<p>Let's switch back to our <code>twitter-wrapper-test.cr</code> file and replace the <code>puts ...</code> line with the following:</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">tweets </span><span style="background-color:#2b303b;color:#c0c5ce;">=</span><span style="background-color:#2b303b;color:#c0c5ce;"> client</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">tweet_search</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">@crystal-lang</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">)</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">tweets</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#c0c5ce;">each </span><span style="background-color:#2b303b;color:#b48ead;">do</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#bf616a;">tweet</span><span style="background-color:#2b303b;color:#c0c5ce;">|</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#96b5b4;">puts</span><span style="background-color:#2b303b;color:#c0c5ce;"> </span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#ab7967;">#{</span><span style="background-color:#2b303b;color:#a3be8c;">tweet</span><span style="background-color:#2b303b;color:#a3be8c;">.</span><span style="background-color:#2b303b;color:#a3be8c;">user</span><span style="background-color:#2b303b;color:#a3be8c;">.</span><span style="background-color:#2b303b;color:#96b5b4;">name</span><span style="background-color:#2b303b;color:#ab7967;">}</span><span style="background-color:#2b303b;color:#a3be8c;"> - </span><span style="background-color:#2b303b;color:#ab7967;">#{</span><span style="background-color:#2b303b;color:#a3be8c;">tweet</span><span style="background-color:#2b303b;color:#a3be8c;">.</span><span style="background-color:#2b303b;color:#a3be8c;">text</span><span style="background-color:#2b303b;color:#ab7967;">}</span><span style="background-color:#2b303b;color:#a3be8c;"> </span><span style="background-color:#2b303b;color:#96b5b4;">\n</span><span style="background-color:#2b303b;color:#96b5b4;">\n</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#b48ead;">end</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span></pre>
<p>And run <code>crystal src/twitter-wrapper-test.cr</code></p>
<p>We should get this!</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">GaryAsh1969 - @burgerbecky iâve been tracking this https://t.co/dMAPThdMuH since using Ruby 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">ysbaddaden - I uploaded the long overdue FreeBSD tarballs for Crystal 0.19.0 up to 0.19.2 https://t.co/vTACMU98Mv 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">piedoomy - RT @CrystalLanguage: Fund Crystal and help it become production-ready! https://t.co/AeBEGvw2TW 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">MattStudies - Great post from the Crystal Team https://t.co/OgczM0lcEN 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">Benchmarks are so frustratingly hard. 
</span><span style="background-color:#2b303b;color:#c0c5ce;">
</span><span style="background-color:#2b303b;color:#c0c5ce;">versiontracker - Crystal 0.19.2 released. https://t.co/4NXtqAh1Lc #compiler #ruby #developers #programming_language #c https://t.co/OrZxr8Rxwv 
</span></pre>
<p>Cool.</p>
<h3 id="for-the-future">For the future & Conclusion</h3>
<p>This is a very simple wrapper, and it doesn't implement everything Twitter has to offer.  Feel free to fully implement your client and push it to GitHub as a shard!</p>
<p>Crystal is constantly changing, so if you notice an issue with any of this code, please let me know so I can update it.  I am also just learning Crystal, so if you have an idea on how to do something better, please let me know.</p>
<h3 id="donate">Donate</h3>
<p>In lieu of donating to me, please consider funding Crystal on Bountysource so they can become production ready!</p>
<p><a href="https://www.bountysource.com/teams/crystal-lang/fundraisers/702-crystal-language"><img src="https://api.bountysource.com/badge/team?team_id=89730&amp;style=raised" alt="Bountysource" /></a></p>
<p>Also, have my this Crystal Cat I made.</p>
<p><img src="/images/building-an-authenticated-web-api-wrapper-with-crystal/crystalcat-02.png" alt="" /></p>

  	</article>
  </section>

  <div id='disqus_thread'></div><script> var disqus_config = function () { }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://vaporsoft-net.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href='https://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>

</div>


    <footer>
      Feather theme by <a href="https://github.com/piedoom/feather">doomy</a>&nbsp;&nbsp;-&nbsp;&nbsp; Built with <a href="https://github.com/Keats/gutenberg">Gutenberg</a>
      &nbsp;&nbsp;-&nbsp;&nbsp; <a href=https:&#x2F;&#x2F;paypal.me&#x2F;piedoomy>Donate</a>
    </footer>

    </body>

</html>
